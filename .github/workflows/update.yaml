name: Deploy to VM
on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  ZONE: "us-east1-b"
  INSTANCE: "dione"


jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - run: echo "$GITHUB_CONTEXT"
    - uses: actions/checkout@v3

    - name: 'GCP Auth'
      uses: 'google-github-actions/auth@v0'
      with:
        credentials_json: '${{ secrets.GCE_SA_KEY }}'
        service_account: '371661757130-compute@developer.gserviceaccount.com'

    - name: 'Set up Cloud SDK'
      uses: 'google-github-actions/setup-gcloud@v0'

    - name: 'Deploy to VM'
      run: |
        gcloud compute ssh --zone ${{ENV.ZONE}} ${{ENV.INSTANCE}} \
        --command '
        echo "Killing Bot" && 
        echo "DONE"'
    
    # - name: 'Deploy to VM'
    #   run: |
    #   gcloud compute ssh --zone ${{ENV.ZONE}} ${{ENV.INSTANCE}} \
    #   --command '
    #   echo "Killing Bot" && 
    #   pkill -9 -f bot.py && 
    #   mkdir -p /home/tmp &&
    #   cd /home/tmp &&
    #   git clone https://github.com/adequevedo/dione.git && 
    #   cp -f dione/bot.py /home/alexdequevedo/bot
    #   cd /home/alexdequevedo/bot && 
    #   sudo google_metadata_script_runner startup'

    # - id: 'compute-ssh'
    #   uses: 'google-github-actions/ssh-compute@v0'
    #   with:
    #     instance_name: 'dione'
    #     zone: 'us-east1-b'
    #     ssh_private_key: '${{ secrets.GCE_SA_KEY }}'
    #     command: 'echo Hello world'

    # Example of using the output
    # - id: 'test'
    #   run: |-
    #     echo '${{ steps.compute-ssh.outputs.stdout }}'
    #     echo '${{ steps.compute-ssh.outputs.stderr }}'